# @usage
#
# on:
#   schedule:
#     - cron: "0 0 * * mon"
# jobs:
#   create_discussion:
#     uses: route06/actions/.github/workflows/create_discussion.yml@v2
#     with:
#         target_day: sunday
#         owner: route06
#         repository_name: professional-service-div-template
#         title: ハドル
#         discussion_category_slug: meeting-notes
#         description_template_path: _templates/weekly_meeting_discussion/test.md

name: Create discussion

on:
  workflow_call:
   inputs: 
    target_day:
      required: true
      type: string
    owner:
      required: true
      type: string
    repository_name:
      required: true
      type: string
    title:
      required: true
      type: string
    discussion_category_slug:
      required: true
      type: string
    description_template_path:
      required: true
      type: string

jobs:
  create_discussion:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: "Asia/Tokyo"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Get next meeting date"
        id: get_date
        run: |
          target_date=$(date -d "next ${{ inputs.target_day }}" +%Y/%m/%d)
          echo "target_date=$target_date" >> "$GITHUB_OUTPUT"

      - name: Run script
        env:
          TARGET_DATE: ${{ steps.get_date.outputs.target_date }}
          OWNER: ${{ inputs.owner }}
          REPOSITORY_NAME: ${{ inputs.repository_name }}
          DISCUSSION_CATEGORY_SLUG: ${{ inputs.discussion_category_slug }} 
          TITLE: ${{ inputs.title }}
          DESCRIPTION_TEMPLATE_PATH: ${{ inputs.description_template_path }}
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");

            /**
            * @param {object} github 
            * @param {string} owner 
            * @param {string} repositoryName 
            * @returns
            */
            async function featchRepoIdAndDiscussionCategoryId(github, owner, repositoryName, discussionCategorySlug) {
              const result = await github.graphql(`query($owner:String!, $repositoryName:String!, $discussionCategorySlug:String!) {
                repository(owner: $owner, name: $repositoryName) {
                  id
                  discussionCategory(slug: $discussionCategorySlug) {
                    id
                  }
                }
              }`, {
                owner: owner,
                repositoryName: repositoryName,
                discussionCategorySlug: discussionCategorySlug,
              });

              return {repositoryId: result.repository.id, categoryId: result.repository.discussionCategory.id};
            }

            async function createWeeklyReportDiscussion(github, repositoryId, categoryId, title, description) {
              const result = await github.graphql(`mutation($repositoryId:ID!, $categoryId:ID!, $title:String!, $body:String!) {
                createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) {
                  discussion {
                    id
                  }
                }
              }`, {
                repositoryId: repositoryId,
                categoryId: categoryId,
                title: title,
                body: description
              });
            }

            const { OWNER, REPOSITORY_NAME, DISCUSSION_CATEGORY_SLUG, TARGET_DATE, TITLE, DESCRIPTION_TEMPLATE_PATH } = process.env;

            const repositoryIdAndCategoryId = await featchRepoIdAndDiscussionCategoryId(
              github,
              OWNER,
              REPOSITORY_NAME,
              DISCUSSION_CATEGORY_SLUG,
            )

            const discussionTitle = `${TARGET_DATE} ${TITLE}`;
            const description = fs.readFileSync(DESCRIPTION_TEMPLATE_PATH, "utf8");

            const discussionId = await createWeeklyReportDiscussion(
              github,
              repositoryIdAndCategoryId.repositoryId,
              repositoryIdAndCategoryId.categoryId,
              discussionTitle,
              description,
            );